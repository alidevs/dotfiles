# =============================================================================
# Plugins
# =============================================================================
set -g @plugin 'tmux-plugins/tpm'
set -g @plugin 'tmux-plugins/tmux-sensible'
set -g @plugin 'rose-pine/tmux'
set -g @plugin 'aserowy/tmux.nvim'
set -g @plugin 'omerxx/tmux-sessionx'
set -g @plugin 'omerxx/tmux-floax'
set -g @plugin 'tmux-plugins/tmux-resurrect'
set -g @plugin 'abhinav/tmux-fastcopy'

# =============================================================================
# Plugin Settings
# =============================================================================
# Rose Pine
set -g @rose_pine_variant 'moon'

# Session X
set -g @sessionx-bind 's'

# Resurrect
set -g @resurrect-capture-pane-contents 'on'
set -g @resurrect-strategy-nvim 'session'

# Floax
set -g @floax-bind 'i'
set -g @floax-border-color '#bb9af7'
set -g @floax-text-color '#7aa2f7'

# =============================================================================
# Terminal & Shell
# =============================================================================
set-option -g default-terminal "tmux-256color"
set -ga terminal-overrides ",xterm-256color:Tc"
set -as terminal-features 'xterm-256color:RGB'
set -as terminal-overrides ',*:Smulx=\E[4::%p1%dm'
set -as terminal-overrides ',*:Setulc=\E[58::2::%p1%{65536}%/%d::%p1%{256}%/%{255}%&%d::%p1%{255}%&%d%;m'
set-option -g set-clipboard on

# set -g default-shell "/opt/homebrew/bin/fish"
# set -g default-command "/opt/homebrew/bin/fish"

set -q -g status-utf8 on
setw -q -g utf8 on

# =============================================================================
# General
# =============================================================================
set -g mouse on
set -g history-limit 30000
set -s escape-time 0

# =============================================================================
# Display
# =============================================================================
set -g status on
set-option -g status-position top
set -g status-interval 1
set -g set-titles on

# Window naming
setw -g automatic-rename on
setw -g automatic-rename-format '#{b:pane_current_path}'

# =============================================================================
# Windows & Panes
# =============================================================================
set -g base-index 1
set -g pane-base-index 1
set-option -g renumber-windows on

# =============================================================================
# Key Bindings - Prefix
# =============================================================================
set -g prefix2 C-a
bind C-a send-prefix -2

# =============================================================================
# Key Bindings - General
# =============================================================================
bind e new-window -n "#{TMUX_CONF_LOCAL}" -e "EDITOR=$EDITOR" sh -c 'case "${EDITOR:-vim}" in *vim) ${EDITOR:-vim} -c ":set syntax=tmux" "$TMUX_CONF_LOCAL";; *) "$EDITOR" "$TMUX_CONF_LOCAL";; esac && "$TMUX_PROGRAM" ${TMUX_SOCKET:+-S "$TMUX_SOCKET"} source "$TMUX_CONF" \; display "$TMUX_CONF_LOCAL sourced"'
bind r source-file ~/.config/tmux/tmux.conf \; display-message "tmux.conf reloaded"
bind '\' set status
if-shell "[[ $(tmux lsw | wc -l) -le 1 ]]" 'set -g status'

# =============================================================================
# Key Bindings - Navigation
# =============================================================================
bind BTab switch-client -l
bind Tab last-window

bind h select-pane -L
bind j select-pane -D
bind k select-pane -U
bind l select-pane -R

# =============================================================================
# Key Bindings - Windows & Panes
# =============================================================================
bind - split-window -v
bind _ split-window -h

bind > swap-pane -D
bind < swap-pane -U

bind -r H resize-pane -L 2
bind -r J resize-pane -D 2
bind -r K resize-pane -U 2
bind -r L resize-pane -R 2

bind -r M-, swap-window -t -1
bind -r M-. swap-window -t +1

bind ! break-pane -d -n _hidden_pane
bind @ join-pane -s $.0

bind R if-shell 'test "#{window_name}" != "#{b:pane_current_path}"' \
    'set-window-option automatic-rename on' \
    'command-prompt -p "New window name:" "rename-window '%%'; set-window-option automatic-rename off"'

# =============================================================================
# Copy Mode
# =============================================================================
setw -g mode-keys vi
bind Enter copy-mode

bind -T copy-mode-vi v send-keys -X begin-selection
bind -T copy-mode-vi C-v send-keys -X rectangle-toggle
bind -T copy-mode-vi y send-keys -X copy-selection
bind -T copy-mode-vi H send-keys -X start-of-line
bind -T copy-mode-vi L send-keys -X end-of-line

bind -T copy-mode-vi Escape if-shell -F '#{selection_present}' \
    'send-keys -X clear-selection' \
    'send-keys -X cancel'

bind -T copy-mode-vi M-h resize-pane -L 1
bind -T copy-mode-vi M-j resize-pane -D 1
bind -T copy-mode-vi M-k resize-pane -U 1
bind -T copy-mode-vi M-l resize-pane -R 1

# =============================================================================
# TPM (keep at bottom)
# =============================================================================
# First time: press prefix + I to install plugins
run '~/.config/tmux/plugins/tpm/tpm'
